S-01.2 — Baseline Schema (SQL)

Goal: создать базовую схему БД: tenants, users, memberships, sites, menus, items, orders, order_items, events.
Scope:
• In: одна SQL-миграция с таблицами/enum’ами/индексами/констрейнтами, updated_at-триггер, проверки целостности, ERD-док.
• Out: RLS, сиды, Realtime-публикации по таблицам (будут в S-01.3…S-01.6).

AC (Gherkin)
• Given проект Supabase привязан
When выполняю миграцию
Then все таблицы и enum’ы созданы без ошибок.
• Given применённая миграция
When выполняю \d по каждой таблице
Then вижу PK/FK/индексы в соответствии с тикетом.
• Given репозиторий
When открываю /packages/contracts/erd.md
Then там описана ER-диаграмма и ключевые связи.

DoD
• В каталоге миграций добавлен файл supabase/migrations/<timestamp>\_baseline_schema.sql
• Миграция успешно применена (локально/в стейджинг)
• В /packages/contracts/erd.md — ERD (текст + ASCII/mermaid)
• Короткая заметка /docs/notes/db-baseline.md с командами запуска

⸻

Микротикеты (атомарные шаги)

S-01.2.a — Подготовить миграцию (enums, helper’ы)

Создай supabase/migrations/<timestamp>\_baseline_schema.sql со стартовым блоком:

-- ENUMS
do $$ begin
create type membership_role_enum as enum ('owner','admin','manager','staff','viewer');
exception when duplicate_object then null; end $$;

do $$ begin
create type order_status_enum as enum ('pending','paid','cancelled','fulfilling','done','refunded');
exception when duplicate_object then null; end $$;

-- UPDATED_AT trigger helper
create or replace function set_updated_at()
returns trigger language plpgsql as $$
begin
  new.updated_at = now();
  return new;
end; $$;

S-01.2.b — Таблицы: tenants, users, memberships, sites

-- TENANTS
create table if not exists public.tenants (
id uuid primary key default gen_random_uuid(),
slug text not null unique, -- для поддоменов/URL
name text not null,
created_at timestamptz not null default now(),
updated_at timestamptz not null default now()
);
create trigger trg_tenants_updated before update on public.tenants
for each row execute function set_updated_at();

-- USERS (глобальные пользователи, связка с auth.users через user_id)
create table if not exists public.users (
id uuid primary key default gen_random_uuid(),
auth_user_id uuid not null unique, -- references auth.users(id) — FK не ставим (разные схемы)
email citext not null unique,
display_name text,
created_at timestamptz not null default now(),
updated_at timestamptz not null default now()
);
create trigger trg_users_updated before update on public.users
for each row execute function set_updated_at();

-- MEMBERSHIPS (много-ко-многим users↔tenants)
create table if not exists public.memberships (
id uuid primary key default gen_random_uuid(),
tenant_id uuid not null references public.tenants(id) on delete cascade,
user_id uuid not null references public.users(id) on delete cascade,
role membership_role_enum not null default 'viewer',
created_at timestamptz not null default now(),
unique (tenant_id, user_id)
);
create index if not exists idx_memberships_tenant on public.memberships(tenant_id);
create index if not exists idx_memberships_user on public.memberships(user_id);

-- SITES (вебсайты/витрины конкретного тенанта)
create table if not exists public.sites (
id uuid primary key default gen_random_uuid(),
tenant_id uuid not null references public.tenants(id) on delete cascade,
domain text, -- кастомный домен (nullable на старте)
name text not null,
is_active boolean not null default true,
created_at timestamptz not null default now(),
updated_at timestamptz not null default now(),
unique (tenant_id, name)
);
create index if not exists idx_sites_tenant on public.sites(tenant_id);
create trigger trg_sites_updated before update on public.sites
for each row execute function set_updated_at();

S-01.2.c — Таблицы: menus, items

-- MENUS (каталоги/меню для сайта)
create table if not exists public.menus (
id uuid primary key default gen_random_uuid(),
tenant_id uuid not null references public.tenants(id) on delete cascade,
site_id uuid not null references public.sites(id) on delete cascade,
title text not null,
currency text not null default 'USD',
is_active boolean not null default true,
created_at timestamptz not null default now(),
updated_at timestamptz not null default now(),
unique (site_id, title)
);
create index if not exists idx_menus_tenant on public.menus(tenant_id);
create index if not exists idx_menus_site on public.menus(site_id);
create trigger trg_menus_updated before update on public.menus
for each row execute function set_updated_at();

-- ITEMS (позиции меню)
create table if not exists public.items (
id uuid primary key default gen_random_uuid(),
tenant_id uuid not null references public.tenants(id) on delete cascade,
menu_id uuid not null references public.menus(id) on delete cascade,
sku text, -- артикул/код
name text not null,
description text,
price_cents integer not null check (price_cents >= 0),
is_active boolean not null default true,
metadata jsonb not null default '{}'::jsonb,
created_at timestamptz not null default now(),
updated_at timestamptz not null default now(),
unique (menu_id, name)
);
create index if not exists idx_items_tenant on public.items(tenant_id);
create index if not exists idx_items_menu on public.items(menu_id);
create index if not exists idx_items_active on public.items(is_active);
create trigger trg_items_updated before update on public.items
for each row execute function set_updated_at();

S-01.2.d — Таблицы: orders, order_items

-- ORDERS
create table if not exists public.orders (
id uuid primary key default gen_random_uuid(),
tenant_id uuid not null references public.tenants(id) on delete cascade,
site_id uuid not null references public.sites(id) on delete restrict,
user_id uuid references public.users(id) on delete set null, -- покупатель (если есть)
status order_status_enum not null default 'pending',
subtotal_cents integer not null default 0 check (subtotal_cents >= 0),
discount_cents integer not null default 0 check (discount_cents >= 0),
total_cents integer not null default 0 check (total_cents >= 0),
currency text not null default 'USD',
external_ref text, -- номер в POS/платёжке
notes text,
metadata jsonb not null default '{}'::jsonb,
created_at timestamptz not null default now(),
updated_at timestamptz not null default now()
);
create index if not exists idx_orders_tenant on public.orders(tenant_id);
create index if not exists idx_orders_site on public.orders(site_id);
create index if not exists idx_orders_status on public.orders(status);
create index if not exists idx_orders_created on public.orders(created_at);
create trigger trg_orders_updated before update on public.orders
for each row execute function set_updated_at();

-- ORDER_ITEMS
create table if not exists public.order_items (
id uuid primary key default gen_random_uuid(),
tenant_id uuid not null references public.tenants(id) on delete cascade,
order_id uuid not null references public.orders(id) on delete cascade,
item_id uuid not null references public.items(id) on delete restrict,
name_snapshot text not null, -- денормализованное имя
unit_price_cents integer not null check (unit_price_cents >= 0),
quantity integer not null check (quantity > 0),
total_cents integer generated always as (unit_price_cents \* quantity) stored,
metadata jsonb not null default '{}'::jsonb,
created_at timestamptz not null default now()
);
create index if not exists idx_order_items_order on public.order_items(order_id);
create index if not exists idx_order_items_tenant on public.order_items(tenant_id);

S-01.2.e — Таблица events (outbox/аудит)

-- EVENTS (CloudEvents-подобная outbox-таблица)
create table if not exists public.events (
id uuid primary key default gen_random_uuid(), -- DB id
tenant_id uuid references public.tenants(id) on delete set null,
event_id text not null unique, -- внешняя идемпотентность
type text not null, -- e.g. "order.paid"
source text not null, -- producer service
subject text,
time timestamptz not null default now(), -- событие произошло
data jsonb not null default '{}'::jsonb,
created_at timestamptz not null default now()
);
create index if not exists idx_events_tenant_time on public.events(tenant_id, time desc);
create index if not exists idx_events_type_time on public.events(type, time desc);

Примечания:
• Все таблицы (кроме memberships) содержат tenant_id для будущих RLS.
• Денормализованные поля (например, order_items.name_snapshot) фиксируют состояние на момент заказа.
• Денежные значения — в центах, integer + check.

⸻

S-01.2.f — Команды применения и проверки

Локально (через Supabase CLI):

supabase db reset # (если можно дропнуть локальную БД)

# или

supabase db push # применить новую миграцию

Проверки:

-- Расширения и типы
select extname from pg_extension where extname in ('vector');
select typname from pg_type where typname in ('membership_role_enum','order_status_enum');

-- Схема
\d public.tenants
\d public.users
\d public.memberships
\d public.sites
\d public.menus
\d public.items
\d public.orders
\d public.order_items
\d public.events

⸻

S-01.2.g — ERD в /packages/contracts/erd.md

Создай файл со сводкой и диаграммой (можно mermaid):

# Potlucky ERD (Baseline)

## Сущности

- **tenants** — организация/клиент.
- **users** — глобальные пользователи (привязка к auth.users по `auth_user_id`).
- **memberships** — роли пользователей в рамках тенанта.
- **sites** — витрины/сайты внутри тенанта.
- **menus** — меню, принадлежит сайту.
- **items** — позиции меню.
- **orders** — заказы по сайту.
- **order_items** — строки заказа.
- **events** — outbox/аудит (CloudEvents-подобная запись).

## Диаграмма (Mermaid)

````mermaid
erDiagram
  tenants ||--o{ memberships : has
  users ||--o{ memberships : has
  tenants ||--o{ sites : has
  sites ||--o{ menus : has
  menus ||--o{ items : has
  tenants ||--o{ orders : has
  sites ||--o{ orders : has
  orders ||--o{ order_items : has
  items ||--o{ order_items : referenced
  tenants ||--o{ events : has

  tenants {
    uuid id PK
    text slug UK
    text name
  }
  users {
    uuid id PK
    uuid auth_user_id UK
    citext email UK
  }
  memberships {
    uuid id PK
    uuid tenant_id FK
    uuid user_id FK
    enum role
  }
  sites {
    uuid id PK
    uuid tenant_id FK
    text domain
    text name
  }
  menus {
    uuid id PK
    uuid tenant_id FK
    uuid site_id FK
    text title
  }
  items {
    uuid id PK
    uuid tenant_id FK
    uuid menu_id FK
    text name
    int  price_cents
  }
  orders {
    uuid id PK
    uuid tenant_id FK
    uuid site_id FK
    uuid user_id FK
    enum status
    int total_cents
  }
  order_items {
    uuid id PK
    uuid tenant_id FK
    uuid order_id FK
    uuid item_id FK
    int quantity
    int total_cents
  }
  events {
    uuid id PK
    uuid tenant_id FK
    text event_id UK
    text type
    timestamptz time
  }

---

### S-01.2.h — Документация
`/docs/notes/db-baseline.md`:
```md
# DB Baseline
- Миграция: supabase/migrations/<timestamp>_baseline_schema.sql
- Денежные поля: *_cents (integer)
- Времена: timestamptz, default now()
- updated_at: триггер set_updated_at()
- Индексы: по tenant_id, status, created_at
- RLS: включим в S-01.3 (deny-by-default)


⸻

Зависимости/стыковки
	•	Требует завершённого S-01.1 (Supabase проект/pgvector).
	•	RLS политики, Storage, Realtime по таблицам — в следующих тикетах.
	•	Сиды демо-данных — S-01.5.

````
