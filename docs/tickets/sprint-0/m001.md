S-01.1 — Provision Supabase

Goal: создать проект в Supabase, включить pgvector и Realtime.
Scope:
• In: новый/существующий проект Supabase (hosted), включённый pgvector, проверка Realtime, фиксация ключей SUPABASE_URL, SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE в env-хранилищах (Vercel) и .env.example.
• Out: бизнес-схема/таблицы, RLS-политики и Realtime подписки по таблицам (это в S-01.2…S-01.6).

⸻

AC (Gherkin)
• Given создан проект Supabase
When я открываю SQL editor и выполняю CREATE EXTENSION IF NOT EXISTS vector
Then расширение установлено без ошибок.
• Given проект создан
When я проверяю auth/v1/health c ANON key
Then получаю 200 OK, ключ работает.
• Given проект создан
When я проверяю наличие публикации supabase_realtime
Then публикация существует (или успешно создаётся пустой).
• Given я зафиксировал секреты
When запускаю локально echo $SUPABASE_URL/$SUPABASE_ANON_KEY
Then значения присутствуют; в клиентском коде отсутствует SERVICE_ROLE.

DoD
• Проект Supabase создан (noted: Project Ref)
• Расширение pgvector включено
• Публикация supabase_realtime существует
• Зафиксированы SUPABASE_URL, SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE в:
• .env.example (плейсхолдеры), без реальных значений
• Vercel (dev/preview/prod)
• Cloudflare wrangler secret (для worker)
• Doppler/1Password для локалки
• Смоки: auth/v1/health = 200; select extname from pg_extension содержит vector
• Док-заметка /docs/notes/supabase-provisioning.md

⸻

Микротикеты (атомарные шаги)

S-01.1.a — Создать проект (CLI или Dashboard)

CLI (если есть организация и токен):

# Установка/логин

npm i -g supabase
supabase login # откроет браузер для auth

# Создание проекта (замени значения)

supabase projects create \
 --org-id <ORG_ID> \
 --name "Potlucky" \
 --db-password "<STRONG_DB_PASSWORD>" \
 --region eu-central-1

# Получи Project Ref (например: abcd1234) и URL/Keys из вывода/консоли

Dashboard (альтернатива):
• Зайти в https://app.supabase.com → New project
• Выбрать организацию, регион, задать Database password
• После создания: Project settings → API и Project settings → Database — выписать:
• Project URL → SUPABASE_URL
• anon public → SUPABASE_ANON_KEY
• service_role secret → SUPABASE_SERVICE_ROLE (хранить только на сервере)

⚠️ Никогда не используем SERVICE_ROLE на клиенте или в публичных логах/репозитории.

⸻

S-01.1.b — Линкануть репо к проекту (CLI)

# В корне репозитория

supabase init # создаст ./supabase/config.toml
supabase link --project-ref <PROJECT_REF>

Сохранит привязку проекта для будущих команд (db push, migration new и т.п.).

⸻

S-01.1.c — Включить pgvector

Через SQL editor в Dashboard или CLI:

-- extensions
create extension if not exists vector; -- для векторного поиска
create extension if not exists pg_stat_statements; -- (полезно, опционально)

Проверка:

select extname from pg_extension where extname in ('vector');

Должно вернуть строку vector.

Позже (S-09.x) добавим таблицы с vector колонками и индексы HNSW/IVFFlat.

⸻

S-01.1.d — Проверить/создать публикацию Realtime

Supabase обычно создаёт публикацию supabase_realtime. Проверим:

select pubname from pg_publication where pubname = 'supabase_realtime';

Если пусто — создать пустую публикацию (таблицы добавим позже при включении Realtime на конкретных таблицах):

create publication supabase_realtime for table none;

Включение Realtime по таблицам будет в S-01.6 (добавим таблицы в публикацию и настроим REPLICA IDENTITY FULL).

⸻

S-01.1.e — Зафиксировать ENV (Vercel/CF/Doppler) и .env.example

.env.example (root):

# Supabase

SUPABASE_URL=https://xxxxx.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1...
SUPABASE_SERVICE_ROLE=SUPABASE_SERVICE_ROLE_SECRET # DO NOT USE ON CLIENT

Vercel (Project → Settings → Environment Variables):
Добавить SUPABASE_URL, SUPABASE_ANON_KEY, SUPABASE_SERVICE_ROLE для Development, Preview, Production.

Cloudflare Worker:

wrangler secret put SUPABASE_URL
wrangler secret put SUPABASE_ANON_KEY
wrangler secret put SUPABASE_SERVICE_ROLE

⸻

S-01.1.f — Смоки (health & доступность ключей)

Проверить anon ключ и URL:

curl -i "$SUPABASE_URL/auth/v1/health"

# Ожидаемо: HTTP/1.1 200 OK

Проверить, что ключи доступны в рантайме:
• В apps/web создать временный server action, залогировать наличие process.env.SUPABASE_URL (не логируй сами значения!).
• В worker — добавить временный /healthz и вернуть маску: { hasUrl: !!env.SUPABASE_URL, hasAnon: !!env.SUPABASE_ANON_KEY }.

Удалить временные логи после проверки.

⸻

S-01.1.g — Документация

Создай /docs/notes/supabase-provisioning.md:

# Supabase Provisioning

- Project Ref: <...>
- Region: eu-central-1
- Enabled extensions: vector
- Realtime publication: supabase_realtime (empty)
- ENV:
  - SUPABASE_URL: set in Vercel/CF/Doppler
  - SUPABASE_ANON_KEY: set
  - SUPABASE_SERVICE_ROLE: set (server-only)
- Health: GET $SUPABASE_URL/auth/v1/health => 200

⸻

Примечания безопасности
• SERVICE*ROLE хранится только на серверной стороне (Vercel server runtime, CF Worker secret). Никогда не экспортируй как NEXT_PUBLIC*….
• RLS по умолчанию «deny-by-default» настроим в S-01.3. До этого не публикуем открытые таблицы в PostgREST.
• Ключи в .env.example — плейсхолдеры; реальные значения — только в секрет-хранилищах.
