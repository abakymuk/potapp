S-00.4 — Codeowners & Branch Rules

Goal: CODEOWNERS + защита main; PR required.
Scope:
• In: файл CODEOWNERS, правило защиты ветки main, шаблон PR, обязательный ревью и зелёный CI.
• Out: релизный процесс, автотеги, auto-merge (позже).

AC (Gherkin)
• Given репозиторий с CODEOWNERS
When открывается PR, затрагивающий пути из CODEOWNERS
Then GitHub автоматически назначает ревьюеров по владельцам путей.
• Given PR в main
When нет ни одного аппрува и/или CI красный
Then кнопка Merge недоступна.
• Given PR в main одобрен, CI зелёный
When пытаются пушнуть напрямую в main
Then push отклонён правилами защиты (для всех, включая админов, если включено).
• Given после аппрува в PR добавлен новый коммит
When включено «Dismiss stale approvals»
Then требуется повторный аппрув перед merge.

DoD
• Добавлен .github/CODEOWNERS с владельцами путей
• Включена защита ветки main: PR required, required status checks, require review from code owners, dismiss stale approvals, resolve conversations
• Добавлен шаблон .github/pull_request_template.md
• Зафиксирована инструкция /docs/notes/codeowners-branch-rules.md
• Smoke-тест: без аппрува merge невозможен; после аппрува и зелёного CI — возможен

⸻

Микротикеты (атомарные шаги)

S-00.4.a — Добавить CODEOWNERS

Создай файл .github/CODEOWNERS:

# Глобальный владелец (замени на свой GitHub username или команду)

- @your-github-username

# Apps

/apps/web/** @frontend-team @your-github-username
/apps/worker/** @platform-team @your-github-username

# Packages

/packages/ui/** @frontend-team @your-github-username
/packages/contracts/** @platform-team @your-github-username
/packages/db/** @platform-team @your-github-username
/packages/lib/** @platform-team @your-github-username

# Документация и конфигурация

/docs/** @your-github-username
.github/** @your-github-username

Замените @frontend-team, @platform-team, @your-github-username на реальные команды/аккаунты в вашей организации.
Если вы пока соло — достаточно указать один @your-github-username. Позже добавите команды.

⸻

S-00.4.b — Шаблон Pull Request

Создай .github/pull_request_template.md:

## Goal

Коротко: что делает PR? Ссылка на тикет.

## Changes

- [ ] Что изменено (списком)

## AC (Gherkin) (если применимо)

- Given …
  When …
  Then …

## Checks

- [ ] Локально `pnpm i && pnpm lint && pnpm typecheck && pnpm build`
- [ ] Нет чувствительных секретов в диффе
- [ ] Обновлена документация (если нужно): /docs/…

## Screens / Evidence (если UI/API контракты)

(вставьте скриншоты/лог/API примеры)

## Feature flags

- Флаги: …
- Rollout: …

⸻

S-00.4.c — Включить защиту main (через UI)

Settings → Branches → Branch protection rules → Add rule: 1. Branch name pattern: main 2. Protect matching branches: ✓ 3. Require a pull request before merging: ✓
• Require approvals: ✓ (минимум 1)
• Require review from Code Owners: ✓
• Dismiss stale pull request approvals when new commits are pushed: ✓
• Require approval of the most recent reviewable push: ✓ (если доступно)
• Require conversation resolution before merging: ✓ 4. Require status checks to pass before merging: ✓
• Выбрать обязательные: CI (Node 20 / pnpm) (из S-00.3)
• (Опционально) Require branches to be up to date before merging: ✓ 5. Require signed commits: (опционально) ✓ 6. Do not allow bypassing the above settings: ✓ 7. Include administrators: ✓ 8. Restrict who can push to matching branches: добавить только CI-бота (если нужен) и/или релизные действия (скоро).

Сохранить.

⸻

S-00.4.d — Включить защиту main (альтернатива: CLI)

Через gh:

OWNER=<org_or_user>
REPO=<repo>

gh api \
 --method PUT \
 -H "Accept: application/vnd.github+json" \
 /repos/$OWNER/$REPO/branches/main/protection \
 -f required_status_checks.strict=true \
 -F required_status_checks.contexts[]="CI (Node 20 / pnpm)" \
 -F enforce_admins=true \
 -f required_pull_request_reviews.dismiss_stale_reviews=true \
 -f required_pull_request_reviews.require_code_owner_reviews=true \
 -f required_pull_request_reviews.required_approving_review_count=1 \
 -f required_pull_request_reviews.require_last_push_approval=true \
 -f restrictions=null

При необходимости добавьте правило «resolve conversations» через UI (API флаг ограничен), и включите required_conversation_resolution если в вашем API доступно.

⸻

S-00.4.e — Smoke-тест защиты 1. Создайте тестовый PR, меняющий файл в зоне ответственности @your-github-username. 2. Проверьте, что GitHub автоматически назначил ревьюера(ов) из CODEOWNERS. 3. Запустится CI (из S-00.3) — пока он не зелёный, Merge недоступен. 4. Без аппрува Merge недоступен. Поставьте аппрув → Merge доступен (если CI зелёный). 5. Сделайте новый коммит в PR → предыдущий аппрув снимается (Dismiss stale approvals), требуется повторный аппрув.

⸻

Документация

Создай /docs/notes/codeowners-branch-rules.md:

# CODEOWNERS & Branch Rules

- CODEOWNERS назначает ревьюеров по путям; хранится в .github/CODEOWNERS
- main защищена: PR required, code owners review, CI required, resolve conversations
- Админы тоже подчиняются правилам (enforce admins)
- Поддерживайте актуальность команд/владельцев при росте команды

⸻

Зависимости
• Требует готового CI статуса из S-00.3 (для «required status checks»).
• Рекомендуется добавить Husky + lint-staged в S-00.5 (pre-commit) для локальной дисциплины.
