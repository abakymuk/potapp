S-00.3 — GitHub Actions: CI

Goal: workflow на PR: install → lint → typecheck → build.
Scope:
	•	In: один GitHub Actions workflow, pnpm + Node 20, кэширование pnpm store и Turbo, статус-чек на PR.
	•	Out: деплой/превью, e2e, sourcemaps в S-07.x и далее.

My repo github.com:abakymuk/potapp.git

AC (Gherkin)
	•	Given открыт Pull Request в main
When срабатывает CI workflow
Then стадии install, lint, typecheck, build выполняются последовательно и зелёно.
	•	Given любой шаг фейлится
When PR открыт
Then мердж блокируется требованием успешного статуса CI.

DoD
	•	Файл .github/workflows/ci.yml добавлен
	•	Кэш pnpm store и .turbo подключён
	•	pnpm lint, pnpm typecheck, pnpm build проходят в CI
	•	Включена защита ветки main с обязательным статусом CI
	•	Короткая заметка /docs/notes/ci.md

⸻

Микротикеты (атомарные шаги)

S-00.3.a — Базовый workflow

Создай .github/workflows/ci.yml:

name: CI

on:
  pull_request:
    branches: [ "main" ]
  push:
    branches: [ "main" ] # чтобы не сломать main пушем

concurrency:
  group: ci-${{ github.ref }} # отменять старые запуски для той же ветки
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  ci:
    name: Node 20 / pnpm
    runs-on: ubuntu-latest
    env:
      TURBO_TELEMETRY_DISABLED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # нужно для корректного sha/release в будущем

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "pnpm"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-${{ runner.os }}-

      - name: Install deps
        run: pnpm i --frozen-lockfile

      - name: Cache Turbo
        uses: actions/cache@v4
        with:
          path: .turbo
          key: turbo-${{ runner.os }}-${{ github.sha }}
          restore-keys: |
            turbo-${{ runner.os }}-

      - name: Lint
        run: pnpm lint

      - name: Typecheck
        run: pnpm typecheck

      - name: Build
        run: pnpm build

Примечания:
	•	Кэш pnpm (actions/setup-node cache: pnpm) + отдельный кэш ~/.pnpm-store ускоряет установку.
	•	Кэш .turbo ускорит повторные билды (при одинаковых артефактах).
	•	concurrency предотвращает гонки для одного PR.

⸻

S-00.3.b — Требование статуса на ветке main

Включи защиту ветки, сделав CI обязательным для мерджа:
	•	Через UI: Settings → Branches → Branch protection rules → Add rule
	•	Branch name pattern: main
	•	✅ Require a pull request before merging
	•	✅ Require status checks to pass before merging
	•	Выбери статус: CI (Node 20 / pnpm) (или просто CI, как в name: job’а)
	•	✅ Require branches to be up to date (опционально)
	•	Сохранить.
	•	Через gh CLI (опционально, пример):

gh api \
  --method PUT \
  -H "Accept: application/vnd.github+json" \
  /repos/:owner/:repo/branches/main/protection \
  -f required_status_checks.strict=true \
  -f required_status_checks.contexts[]="CI (Node 20 / pnpm)" \
  -f enforce_admins=true \
  -f required_pull_request_reviews.dismiss_stale_reviews=true \
  -f required_pull_request_reviews.required_approving_review_count=1



Важно: название статуса должно совпасть с jobs.ci.name. Если изменишь — обнови правило.

⸻

S-00.3.c — Документация

Создай /docs/notes/ci.md:

# CI Workflow
- Триггеры: PR→main, push→main
- Стадии: install → lint → typecheck → build
- Node 20.x, pnpm 9, кэш pnpm & Turbo
- Статус-чек: "CI (Node 20 / pnpm)" обязателен для мерджа в main
- Команды:
  - Локально повторить: `pnpm i && pnpm lint && pnpm typecheck && pnpm build`


⸻

S-00.3.d — Smoke-проверка
	1.	Создай тестовый PR, намеренно сломай линт (например, удали импорт).
	2.	Убедись, что статус CI красный и GitHub блокирует merge.
	3.	Исправь, пушни снова — CI зеленый, merge доступен.

⸻

Зависимости/стыковки
	•	Требует выполненного S-00.1 (скрипты build, структура пакетов) и S-00.2 (скрипты lint, typecheck).
	•	Публикация sourcemaps, многоплатформенная матрица и превью-деплой — в последующих тикетах (S-07.x / deploy).